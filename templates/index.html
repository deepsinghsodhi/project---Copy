

<!DOCTYPE html>
<html>
<head>
    <title>PDF Table Extractor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        
        .data-table td[title] {
            cursor: help;
        }
        .button-row {
    height: auto; /* Or specify a fixed height */
}

        </style>
    <style>

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .requirements-selector {
    display: flex;
    flex-direction: column;
    gap: 5px;
}


.requirements-selector label {
    font-size: 14px;
    color: #495057;
}

.age-group-select {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    min-width: 200px;
}

.age-group-select:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

        .age-group-select {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    min-width: 200px;
}

.age-group-select:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
.dropdown-container {
    margin: 20px 0;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.dropdown-container select {
    margin-left: 10px;
    min-width: 200px;
}

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        #uploadForm {
            text-align: center;
            margin: 20px 0;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .file-input-container {
            position: relative;
            display: inline-block;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #45a049;
        }

        input[type="file"] {
            display: none;
        }

        .selected-file {
            margin-top: 10px;
            color: #666;
        }

        .table-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px auto;
            padding: 20px;
        }

        .table-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page-number {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .table-image {
            width: 100%;
            height: auto;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #555;
            font-size: 0.9em;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .cp-btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.cp-btn:hover {
    background-color: #218838;
}

.pdcaas-btn {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.pdcaas-btn:hover {
    background-color: #0056b3;
}

.button-row {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

/* Update existing button styles to match if needed */
.process-btn, .calculate-btn, .drop-btn, .amino-btn {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
}
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .racc-container {
    margin: 15px 0;
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    padding: 6px 12px;
    border-radius: 4px;
}

.css-value {
    background-color: #f8f9fa;
    transition: background-color 0.3s;
}

.css-value:hover {
    background-color: #e9ecef;
}

        .extracted-data {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        #downloadBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        

     
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .loading-spinner {
            display: none;
            margin: 20px auto;
            text-align: center;
        }

        .loading-spinner i {
            color: #2196F3;
            font-size: 2em;
        }
.demo-btn {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
}

.demo-btn:hover {
    background-color: #0056b3;
}

.demo-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.requirements-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #fff;
}

.requirements-table th,
.requirements-table td {
    border: 1px solid #ddd;
    padding: 12px 8px;
    text-align: left;
}

.requirements-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.requirements-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.requirements-table tr:hover {
    background-color: #f5f5f5;
}

.button-container {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.error-message {
    color: #dc3545;
    padding: 10px;
    margin-top: 10px;
    background-color: #fff3f3;
    border: 1px solid #dc3545;
    border-radius: 4px;
}

#aminoAcidsTable td[title] {
    cursor: help;
}

#aminoAcidsTable td[title]:hover {
    background-color: #c8e6c9 !important;
}
.multiplication-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #fff;
}

.multiplication-table th,
.multiplication-table td {
    border: 1px solid #ddd;
    padding: 12px 8px;
    text-align: left;
}

.multiplication-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.multiplication-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.multiplication-table tr:hover {
    background-color: #f5f5f5;
}

#multiplicationResultContainer h3 {
    margin: 20px 0 10px 0;
    color: #333;
}

.error-message {
    color: #dc3545;
    padding: 10px;
    margin-top: 10px;
    background-color: #fff3f3;
    border: 1px solid #dc3545;
    border-radius: 4px;
}
        .demo-btn,.multiply-btn {
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin: 20px 0;
    transition: background-color 0.3s;
}

.demo-btn:hover {
    background-color: #0056b3;
}

.demo-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.requirements-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #fff;
}

.requirements-table th,
.requirements-table td {
    border: 1px solid #ddd;
    padding: 12px 8px;
    text-align: left;
}#addASSBtn,#saveASSBtn {
    height: 40px;
    padding: 10px 20px;
    font-size: 14px;
    line-height: 1.2;
    white-space: nowrap;
    min-width: fit-content;
    background-color: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
}
#saveASSBtn:hover {
    background-color: #c00fd0;
}
#addASSBtn:hover {
    background-color: #108135;
}
.requirements-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
}

.requirements-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.requirements-table tr:hover {
    background-color: #f5f5f5;
}

.error-message {
    color: #dc3545;
    padding: 10px;
    margin-top: 10px;
    background-color: #fff3f3;
    border: 1px solid #dc3545;
    border-radius: 4px;
}
.button-container {
    margin-top: 20px;
    text-align: center;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
    border-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #cccccc;
    border-color: #cccccc;
    cursor: not-allowed;
    opacity: 0.65;
}

.btn-primary.active {
    background-color: #28a745;
    border-color: #28a745;
}

/* Add animation for the download icon */
.fa-download {
    margin-right: 8px;
}

.btn-primary:not(:disabled):hover .fa-download {
    transform: translateY(2px);
    transition: transform 0.2s ease;
}
.racc-container {
    margin: 15px 0;
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    padding: 6px 12px;
    border-radius: 4px;
}

.css-value {
    background-color: #f8f9fa;
    transition: background-color 0.3s;
}

.css-value:hover {
    background-color: #e9ecef;
}

/* Status cell styling */
.status-value {
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 4px;
    text-align: center;
}

.excellent-source-of-protein {
    background-color: #28a745;
    color: black;
}

.good-source-of-protein {
    background-color: #ffc107;
    color: black;
}

.poor-source-of-protein {
    background-color: #dc3545;
    color: black;
}

/* Add hover effect for status cells */
.status-value:hover {
    opacity: 0.9;
}

/* Add some spacing between columns */
td, th {
    padding: 8px 12px !important;
}
/* Make table scrollable horizontally on small screens */
@media screen and (max-width: 768px) {
    .requirements-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}
    
   
    .fetch-btn {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 20px;
        transition: background-color 0.3s;
    }
    
    .fetch-btn:hover {
        background-color: #0056b3;
    }
    
    .fetch-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    
    .loading-spinner {
        font-style: italic;
    }
    
    #errorMessage {
        padding: 10px;
        margin: 10px 0;
        background-color: #fff3f3;
        border: 1px solid #dc3545;
        border-radius: 4px;
        color: #dc3545;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background-color: #fff;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
    }
    
    .data-table th {
        background-color: #f5f5f5;
    }
    .data-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .data-table tr:hover {
        background-color: #f5f5f5;
    }
    
    @media screen and (max-width: 768px) {
        .data-table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    
    .data-table th,
    .data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    .data-table th {
        background-color: #f4f4f4;
        font-weight: bold;
    }
    
    .data-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .data-table tr:hover {
        background-color: #f5f5f5;
    }
         .amino-btn {
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .amino-btn:hover {
        background-color: #218838;
    }
    
    .amino-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    
    #aminoTableContainer h3 {
        margin: 20px 0 10px 0;
        color: #333;
    }
         .drop-btn {
        padding: 10px 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .drop-btn:hover {
        background-color: #c82333;
    }
    
    .drop-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
         .error-message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            background-color: #fff;
            border-left: 4px solid #dc3545;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 16px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .error-message-title {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-message-content {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .error-message-list {
            list-style: none;
            padding-left: 0;
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .error-message-list li {
            padding: 2px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .error-message-list li::before {
            content: "•";
            color: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        .text-column {
        text-align: left;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .input-section {
            margin-bottom: 20px;
        }
        #tableInput {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        .table-container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        .numeric-column {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .process-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .process-btn:hover {
            background-color: #45a049;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .calculate-btn {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 10px 0;
    }
    
    .calculate-btn:hover {
        background-color: #45a049;
    }
    .error-message-container {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 300px;
        background-color: #fff;
        border-left: 4px solid #dc3545;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        padding: 16px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }

    .error-message-title {
        color: #dc3545;
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .error-message-content {
        color: #666;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .error-message-list {
        list-style: none;
        padding-left: 0;
        margin: 8px 0;
        color: #666;
        font-size: 14px;
    }

    .error-message-list li {
        padding: 2px 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .error-message-list li::before {
        content: "•";
        color: #dc3545;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }
    .btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    cursor: pointer;
}

.btn-secondary:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}

.btn-secondary:hover:not(:disabled) {
    background-color: #5a6268;
    border-color: #545b62;
}

.mt-3 {
    margin-top: 1rem;
}
    .me-2 {
        margin-right: 0.5rem;
    }
    .gap-2 {
    gap: 0.5rem;
}

.btn:disabled {
    cursor: not-allowed;
    opacity: 0.65;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-secondary:hover:not(:disabled) {
    background-color: #5a6268;
    border-color: #545b62;
}
    </style>
</head>
<body>
    <div>
    <div class="container">
        <h1>PDF Table Extractor</h1>
        
        <form id="uploadForm">
            <div class="file-input-container">
                <label class="file-input-label">
                    <i class="fas fa-file-upload"></i> Choose PDF File
                    <input type="file" name="file" accept=".pdf" required>
                </label>
            </div>
            <div class="selected-file"></div>
        </form>

        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing PDF...</p>
        </div>

      
    </div>

    
    <div class="button-container">
        <button id="downloadBtn" class="btn btn-primary" onclick="downloadTableAsCSV()" disabled>
            <i class="fas fa-download"></i> Download Final Output
        </button>
    </div>
    
    <script>

// Define the global variable at the very top
const selectedPattern = {
    year: '',
    ageGroup: ''
};

function storeSelectedPattern() {
    const indianSelect = document.getElementById('indianAgeGroupSelect');
    const whoSelect = document.getElementById('whoAgeGroupSelect');
    const faoSelect = document.getElementById('faoWhoUnuSelect');

    if (indianSelect && indianSelect.value) {
        localStorage.setItem('patternYear', '1991');
        localStorage.setItem('patternAgeGroup', indianSelect.value);
    } else if (whoSelect && whoSelect.value) {
        localStorage.setItem('patternYear', '2007');
        localStorage.setItem('patternAgeGroup', whoSelect.value);
    } else if (faoSelect && faoSelect.value) {
        localStorage.setItem('patternYear', '2013');
        localStorage.setItem('patternAgeGroup', faoSelect.value);
    }
}
function updateSelectedPattern() {
    // Get the select elements after they've been created
    const indianSelect = document.getElementById('indianAgeGroupSelect');
    const whoSelect = document.getElementById('whoAgeGroupSelect');
    const faoSelect = document.getElementById('faoWhoUnuSelect');

    // Store the currently selected values
    if (indianSelect && indianSelect.value) {
        selectedPattern.year = '1991';
        selectedPattern.ageGroup = indianSelect.value;
    } else if (whoSelect && whoSelect.value) {
        selectedPattern.year = '2007';
        selectedPattern.ageGroup = whoSelect.value;
    } else if (faoSelect && faoSelect.value) {
        selectedPattern.year = '2013';
        selectedPattern.ageGroup = faoSelect.value;
    }
}

// Function to attach event listeners after elements are created
function attachSelectListeners() {
    const indianSelect = document.getElementById('indianAgeGroupSelect');
    const whoSelect = document.getElementById('whoAgeGroupSelect');
    const faoSelect = document.getElementById('faoWhoUnuSelect');

    if (indianSelect) {
        indianSelect.addEventListener('change', updateSelectedPattern);
    }
    if (whoSelect) {
        whoSelect.addEventListener('change', updateSelectedPattern);
    }
    if (faoSelect) {
        faoSelect.addEventListener('change', updateSelectedPattern);
    }
}

function downloadTableAsCSV() {
    try {
        const table = document.querySelector('#dataTable');
        if (!table) {
            throw new Error('Table not found');
        }

        // Get stored pattern info from localStorage
        const year = localStorage.getItem('patternYear');
        const ageGroup = localStorage.getItem('patternAgeGroup');

        // Generate filename
        let fileName = 'protein_quality_results';
        
        if (year && ageGroup) {
            let formattedAgeGroup = ageGroup;

            // Format age group based on pattern year
            if (year === '2013') {
                const ageGroupMap = {
                    'infant': 'Infant_0_6mo',
                    'child': 'Child_6mo_3yr',
                    'above3': 'Above_3yr'
                };
                formattedAgeGroup = ageGroupMap[ageGroup] || ageGroup;
            } else if (year === '2007') {
                formattedAgeGroup = ageGroup.replace(/\./g, '_');
            } else if (year === '1991') {
                formattedAgeGroup = ageGroup.replace(/\s+/g, '_');
            }

            fileName = `${year}_${formattedAgeGroup}`;

        }

        // Get headers
        const headers = Array.from(table.querySelectorAll('thead th'))
            .map(th => th.textContent.trim());

        // Get rows
        const rows = Array.from(table.querySelectorAll('tbody tr'))
            .map(row => Array.from(row.querySelectorAll('td'))
                .map(cell => cell.textContent.trim()));

        // Create CSV content
        let csvContent = headers.join(',') + '\n';
        csvContent += rows.map(row => row.join(','))
            .join('\n');

        // Create blob and download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        // Set download attributes
        link.setAttribute('href', url);
        link.setAttribute('download', `${fileName}.csv`);
        link.style.visibility = 'hidden';
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    } catch (error) {
        alert('Error downloading table: ' + error.message);
    }
}


// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const indianSelect = document.getElementById('indianAgeGroupSelect');
    const whoSelect = document.getElementById('whoAgeGroupSelect');
    const faoSelect = document.getElementById('faoWhoUnuSelect');

    if (indianSelect) {
        indianSelect.addEventListener('change', () => {
            updateSelectedPattern();
        });
    }
    if (whoSelect) {
        whoSelect.addEventListener('change', () => {
            updateSelectedPattern();
        });
    }
    if (faoSelect) {
        faoSelect.addEventListener('change', () => {
            updateSelectedPattern();
        });
    }
});


function calculateCSS() {
    try {
        const table = document.querySelector('#dataTable');
        if (!table) {
            throw new Error('Table not found');
        }
        

        // Get RACC value
        const raccValue = parseFloat(document.getElementById('raccValue').value);
        if (isNaN(raccValue)) {
            throw new Error('Please enter a valid RACC value');
        }

        // Get saved CP values and create case-insensitive lookup
        const cpValues = JSON.parse(localStorage.getItem('cpValues'));
        if (!cpValues) {
            throw new Error('Please calculate and save CP values first');
        }

        // Create case-insensitive lookup for CP values
        const caseInsensitiveCP = Object.entries(cpValues).reduce((acc, [key, value]) => {
            acc[key.toLowerCase()] = value;
            return acc;
        }, {});

        // Find required columns (case-insensitive)
        const headers = Array.from(table.querySelectorAll('thead th'));
        const pdcaasIndex = headers.findIndex(th => th.textContent.toUpperCase() === 'PDCAAS');
        
        if (pdcaasIndex === -1) {
            throw new Error('PDCAAS column not found');
        }

        // Add CSS and Content Claim Status column headers if they don't exist
        const headerRow = table.querySelector('thead tr');
        
        // Check if CSS column exists (case-insensitive)
        let cssIndex = headers.findIndex(th => th.textContent.toUpperCase() === 'CSS');
        if (cssIndex === -1) {
            const cssHeader = document.createElement('th');
            cssHeader.textContent = 'CSS';
            headerRow.appendChild(cssHeader);
            cssIndex = headers.length;
        }

        // Check if Content Claim Status column exists (case-insensitive)
        let statusIndex = headers.findIndex(th => th.textContent.toUpperCase() === 'CONTENT CLAIM STATUS');
        if (statusIndex === -1) {
            const statusHeader = document.createElement('th');
            statusHeader.textContent = 'Content Claim Status';
            headerRow.appendChild(statusHeader);
            statusIndex = headers.length;
        }

        // Calculate CSS and determine status for each row
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = Array.from(row.cells);
            const sampleName = cells[0].textContent.trim();
            const pdcaasValue = parseFloat(cells[pdcaasIndex].textContent);
            // Use case-insensitive lookup
            const cpValue = caseInsensitiveCP[sampleName.toLowerCase()];

            if (cpValue && !isNaN(pdcaasValue)) {
                const cssValue = (cpValue/100) * (pdcaasValue/100) * raccValue;
                
                // Add or update CSS cell
                let cssCell;
                if (cells.length > cssIndex) {
                    cssCell = cells[cssIndex];
                } else {
                    cssCell = document.createElement('td');
                    row.appendChild(cssCell);
                }
                cssCell.textContent = cssValue.toFixed(2);
                cssCell.title = `(${cpValue}/100) × (${pdcaasValue}/100) × ${raccValue}`;
                cssCell.classList.add('css-value');

                // Determine Content Claim Status
                let status;
                if (cssValue >= 10) {
                    status = 'Excellent Source of Protein';
                } else if (cssValue >= 5) {
                    status = 'Good Source of Protein';
                } else {
                    status = 'Poor Source of Protein';
                }

                // Add or update Status cell
                let statusCell;
                if (cells.length > statusIndex) {
                    statusCell = cells[statusIndex];
                } else {
                    statusCell = document.createElement('td');
                    row.appendChild(statusCell);
                }
                statusCell.textContent = status;
                statusCell.className = 'status-value ' + status.toLowerCase().replace(/ /g, '-');
            } else {
                console.log(`No CP value found for sample: ${sampleName} (tried case-insensitive match)`);
            }
        });

        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.disabled = false;
        }

        // Update the pattern information when CSS is calculated
        window.updateSelectedPattern();

        alert('CSS values and Content Claim Status calculated successfully!');

    } catch (error) {
        alert(error.message);
    }
}

function disableDownloadButton() {
    const downloadBtn = document.getElementById('downloadBtn');
    if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.title = 'Calculate CSS first to enable download';  // Optional tooltip
    }
}

// You might want to call disableDownloadButton() when the page loads
document.addEventListener('DOMContentLoaded', disableDownloadButton);

    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        
            // Function to add checkbox listeners
            function addCheckboxListeners() {
                document.querySelectorAll('.table-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateDownloadButton);
                });
            }
        

          

            async function extractTableData() {
    const selectedImages = Array.from(document.querySelectorAll('.image-checkbox:checked'))
                              .map(cb => cb.value);
    
    if (selectedImages.length === 0) {
        alert('Please select at least one image');
        return;
    }

    // Get DOM elements
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultsContainer = document.getElementById('results-container');
    const extractBtn = document.getElementById('extract-btn');
    
    // Check if elements exist
    if (!loadingIndicator || !resultsContainer || !extractBtn) {
        console.error('Required elements not found:', {
            loadingIndicator: !!loadingIndicator,
            resultsContainer: !!resultsContainer,
            extractBtn: !!extractBtn
        });
        return;
    }

    try {
        // Show loading state
        loadingIndicator.style.display = 'block';
        extractBtn.disabled = true;
        resultsContainer.innerHTML = '';

        const response = await fetch('/extract_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ selected_images: selectedImages })
        });

        const data = await response.json();
        
        if (data.success) {
            let resultsHTML = '<h2>Extracted Data</h2>';
            data.results.forEach(result => {
                resultsHTML += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${result.image_name}</h5>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="copyToClipboard('${result.image_name}')">
                                Copy Data
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <img src="/static/images/${result.image_name}" 
                                         alt="Source table" 
                                         class="img-fluid mb-3"
                                         style="max-height: 200px; object-fit: contain;">
                                </div>
                                <div class="col-md-9">
                                    <div class="table-responsive" id="data-${result.image_name}">
                                        ${result.extracted_data}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            resultsContainer.innerHTML = resultsHTML;
        } else {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Error: ${data.error}
                </div>
            `;
        }
    } catch (error) {
        resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                Error: ${error.message}
            </div>
        `;
    } finally {
        // Hide loading state
        loadingIndicator.style.display = 'none';
        extractBtn.disabled = false;
    }
}


// function updateExtractButton() {
//     const selectedSavedImages = document.querySelectorAll('.saved-image-checkbox:checked');
//     const extractBtn = document.getElementById('extractBtn');
    
//     if (extractBtn) {
//         extractBtn.disabled = selectedSavedImages.length === 0;
//     }
// }


        
            // Initialize everything
            addCheckboxListeners();
        });
        
        // Make downloadSelectedImages available globally
        window.downloadSelectedImages = async function() {
            const selectedImages = Array.from(document.querySelectorAll('.table-checkbox:checked'))
                                      .map(cb => cb.value);
            
            if (selectedImages.length === 0) {
                alert('Please select at least one image');
                return;
            }
        
            try {
                const response = await fetch('/download_tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filenames: selectedImages })
                });
        
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'selected_tables.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const errorData = await response.json();
                    alert(`Error downloading images: ${errorData.error}`);
                }
            } catch (error) {
                alert('Error downloading images');
            }
        };
        </script>
        
        <style>
        .button-container {
            margin-top: 20px;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.65;
        }
        
        .btn-primary.active {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .fa-download {
            margin-right: 8px;
        }
        
        .btn-primary:not(:disabled):hover .fa-download {
            transform: translateY(2px);
            transition: transform 0.2s ease;
        }
        
        .table-checkbox {
            margin-right: 5px;
        }
        .saved-images-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .saved-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }


        .saved-image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        </style>
    
   

       

   

<script>


    async function extractTableData() {
        const selectedImages = Array.from(document.querySelectorAll('.image-checkbox:checked'))
                                  .map(cb => cb.value);
        
        if (selectedImages.length === 0) {
            alert('Please select at least one image');
            return;
        }

        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const extractBtn = document.getElementById('extract-btn');
        
        // Check if elements exist
        if (!loadingIndicator || !resultsContainer || !extractBtn) {
            console.error('Required elements not found:', {
                loadingIndicator: !!loadingIndicator,
                resultsContainer: !!resultsContainer,
                extractBtn: !!extractBtn
            });
            return;
        }

        try {
            loadingIndicator.style.display = 'block'; // This line causes the error if loadingIndicator is null
            extractBtn.disabled = true;
            resultsContainer.innerHTML = '';

            const response = await fetch('/extract_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ selected_images: selectedImages })
            });

            const data = await response.json();
            
            if (data.success) {
                let resultsHTML = '<h2>Extracted Data</h2>';
                data.results.forEach(result => {
                    resultsHTML += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${result.image_name}</h5>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="copyToClipboard('${result.image_name}')">
                                    Copy Data
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <img src="/static/images/${result.image_name}" 
                                             alt="Source table" 
                                             class="img-fluid mb-3"
                                             style="max-height: 200px; object-fit: contain;">
                                    </div>
                                    <div class="col-md-9">
                                        <div class="table-responsive" id="data-${result.image_name}">
                                            ${result.extracted_data}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                resultsContainer.innerHTML = resultsHTML;
            } else {
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Error: ${data.error}
                    </div>
                `;
            }
        } catch (error) {
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Error: ${error.message}
                </div>
            `;
        } finally {
            loadingIndicator.style.display = 'none'; // This line also causes the error if loadingIndicator is null
            extractBtn.disabled = false;
        }
    }




    </script>
       
 

<style>
    /* Add or update these styles */
    .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .image-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        #loading-indicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

    .form-check {
        margin-top: 8px;
    }

    /* Results section styling */
    .card-body img {
        max-width: 300px; /* Maximum width for images in results */
        height: auto;
        object-fit: contain;
        margin: 10px 0;
    }

    .table-responsive {
        margin-top: 15px;
    }

    .loading {
        text-align: center;
        padding: 20px;
    }
</style>

    <!-- Saved Images Section -->
   

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span id="loadingText">Processing images...</span>
        </div>
    </div>

    <!-- Results Container -->
    <div class="results-container" id="resultsContainer"></div>
</div>

<script>
    let isProcessing = false;

// Update the updateSavedImages function
async function updateSavedImages() {
    const savedImagesGrid = document.getElementById('savedImagesGrid');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    try {
        // Show loading only if not already showing saved images
        if (savedImagesGrid.children.length === 0) {
            loadingIndicator.style.display = 'block';
        }

        const response = await fetch('/get_saved_images');
        const data = await response.json();
        
        if (data.success) {
            // Clear and update the grid
            savedImagesGrid.innerHTML = '';
            
            if (data.images.length === 0) {
                savedImagesGrid.innerHTML = '<p>No saved images found.</p>';
                return;
            }

            // Create all image cards
            const imageCards = data.images.map((image, index) => `
                <div class="saved-image-card">
                    <img src="/static/images/${image}?t=${new Date().getTime()}" 
                         class="saved-image-preview" 
                         alt="${image}"
                         loading="lazy">
                    <div class="form-check">
                        <input class="form-check-input saved-image-checkbox" 
                               type="checkbox" 
                               value="${image}" 
                               id="saved_${index}"
                               onchange="updateExtractButton()">
                        <label class="form-check-label" for="saved_${index}">
                            ${image}
                        </label>
                    </div>
                </div>
            `).join('');
            
            savedImagesGrid.innerHTML = imageCards;
            updateExtractButton();
        } else {
            savedImagesGrid.innerHTML = `<p class="text-danger">Error loading images: ${data.error}</p>`;
        }
    } catch (error) {

        savedImagesGrid.innerHTML = '<p class="text-danger">Error loading saved images</p>';
    } finally {
        loadingIndicator.style.display = 'none';
    }
}




    // Function to extract data using Gemini API
   
    // Your existing updateButtons and copyToClipboard functions...
</script>


    

    <div class="container">
        <h1>Table Data Processor</h1>
        
        <div class="input-section">
            <textarea id="tableInput" placeholder="Paste your table data here"></textarea>
            <div class="button-row">
                <button class="process-btn" onclick="processTableData()">Process Table</button>
                <button class="calculate-btn" onclick="calculateSums()">Calculate MET+CYS and PHE+TYR</button>
                <button class="drop-btn" onclick="dropPDCAASColumns()">Drop PDCAAS Columns</button>
                <button class="cp-btn" onclick="calculateAndSaveCP()">Save CP Values</button>
                <button class="amino-btn" onclick="calculateAminoAcids()">Calculate Essential Amino Acids</button>
            </div>
        </div>
        
        <div id="tableContainer" class="table-container"></div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>
    <script>

        // Add this function to create and handle the dropdown
// Function to create and handle the dropdown
// Function to create and handle the dropdown
async function createTableDropdown() {
    try {
        // Fetch table captions first
        const response = await fetch('/get_table_captions');
        if (!response.ok) {
            throw new Error('Failed to fetch table captions');
        }
        const captions = await response.json();

        const dropdownContainer = document.createElement('div');
        dropdownContainer.className = 'dropdown-container mt-3';
        
        const label = document.createElement('label');
        label.textContent = 'Select Table: ';
        label.htmlFor = 'tableSelector';
        
        const select = document.createElement('select');
        select.id = 'tableSelector';
        select.className = 'form-select';

        // Add a default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Choose a table...';
        select.appendChild(defaultOption);
        
        // Add options using the captions
        captions.forEach(({id, caption}) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = caption;
            select.appendChild(option);
        });
        
        dropdownContainer.appendChild(label);
        dropdownContainer.appendChild(select);
        
        const table = document.querySelector('.data-table');
        table.parentNode.insertBefore(dropdownContainer, table.nextSibling);
        
        select.addEventListener('change', function() {
            if (this.value) {
                fetchTableData(this.value);
            }
        });

    } catch (error) {
        console.error('Error creating dropdown:', error);
        alert('Error loading table options. Please try again.');
    }
}


async function fetchTableData(tableId) {
    try {

        const response = await fetch(`/get_table_data/${tableId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || `HTTP error! status: ${response.status}`);
        }
        
        displayTableData(data);
    } catch (error) {
        alert(Error `fetching table data: ${error.message}`);
    }
}

function displayTableData(data) {
    let resultHTML = `
        <div class="mt-3">
            <h4>${data.tableName}</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.rows.forEach((row) => {
        resultHTML += `
            <tr>
                <td>${row.secondColumn}</td>
                <td>${row.thirdColumn}</td>
            </tr>
        `;
    });
    
    resultHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    const container = document.querySelector('.dropdown-container');
    const existingTable = document.getElementById('fetchedDataTable');
    if (existingTable) {
        existingTable.remove();
    }
    
    const tableDiv = document.createElement('div');
    tableDiv.id = 'fetchedDataTable';
    tableDiv.innerHTML = resultHTML;
    container.appendChild(tableDiv);
}

// Add this to your calculatePDCAASAndIVPDCAAS function after calculations are complete
function addDropdownAfterCalculations() {
    setTimeout(() => {
        addRaccInputAndCssColumn(); // Add RACC input first
        createTableDropdown().catch(error => {
            console.error('Error adding dropdown after calculations:', error);
        });
    }, 100);
}

function calculatePDCAASAndIVPDCAAS() {
    try {
        // Get saved AAS values from localStorage
        const savedASSValues = JSON.parse(localStorage.getItem('assValues'));
        if (!savedASSValues) {
            alert('Please calculate and save AAS values first!');
            return;
        }

        // Create case-insensitive lookup for AAS values
        const caseInsensitiveAAS = Object.entries(savedASSValues).reduce((acc, [key, value]) => {
            acc[key.toLowerCase()] = value;
            return acc;
        }, {});

        const table = document.querySelector('.data-table, #dataTable');
        if (!table) {
            alert('Please process the table data first!');
            return;
        }

        const headers = Array.from(table.querySelectorAll('thead th'));
        
        // Find required column indices (case-insensitive)
        const aasIndex = headers.findIndex(th => th.textContent.toUpperCase() === 'AAS');
        const tpdIndex = headers.findIndex(th => ['%TPD', 'TPD'].includes(th.textContent.toUpperCase()));
        const ivpdIndex = headers.findIndex(th => th.textContent.toUpperCase() === 'IVPD');
        
        if (aasIndex === -1 || tpdIndex === -1 || ivpdIndex === -1) {
            throw new Error('Required columns (AAS, TPD, or IVPD) not found');
        }

        // Add or update PDCAAS and IVPDCAAS columns
        const headerRow = table.querySelector('thead tr');
        
        // Check and add PDCAAS column after IVPD
        if (!headers.some(th => th.textContent.toUpperCase() === 'PDCAAS')) {
            const pdcaasHeader = document.createElement('th');
            pdcaasHeader.textContent = 'PDCAAS';
            headerRow.insertBefore(pdcaasHeader, headerRow.children[ivpdIndex + 1]);
        }
        
        // Check and add In Vitro PDCAAS column
        if (!headers.some(th => th.textContent.toUpperCase() === 'IN VITRO PDCAAS')) {
            const ivpdcaasHeader = document.createElement('th');
            ivpdcaasHeader.textContent = 'in vitro PDCAAS';
            headerRow.appendChild(ivpdcaasHeader);
        }

        // Function to extract main value from string with brackets
        function extractMainValue(text) {
            const match = text.match(/^([\d.]+)/);
            return match ? parseFloat(match[1]) : NaN;
        }

        // Calculate values for each row
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const sampleName = cells[0].textContent.trim();
            // Use case-insensitive lookup
            const assValue = caseInsensitiveAAS[sampleName.toLowerCase()];
            
            if (assValue) {
                // Update AAS column with saved value
                cells[aasIndex].textContent = assValue.toFixed(2);
                
                // Calculate PDCAAS
                const tpdText = cells[tpdIndex].textContent.trim();
                const tpdValue = extractMainValue(tpdText) / 100; // Convert percentage to decimal
                
                if (!isNaN(tpdValue)) {
                    const pdcaas = (assValue * tpdValue * 100).toFixed(2);
                    
                    // Add or update PDCAAS cell
                    let pdcaasCell = cells[ivpdIndex + 1];
                    if (!pdcaasCell) {
                        pdcaasCell = document.createElement('td');
                        row.insertBefore(pdcaasCell, cells[ivpdIndex].nextSibling);
                    }
                    pdcaasCell.textContent = pdcaas;
                    pdcaasCell.title = `${assValue} × ${tpdValue * 100}%`;
                }

                // Calculate IVPDCAAS
                const ivpdText = cells[ivpdIndex].textContent.trim();
                const ivpdValue = extractMainValue(ivpdText) / 100; // Convert percentage to decimal
                
                if (!isNaN(ivpdValue)) {
                    const ivpdcaas = (assValue * ivpdValue * 100).toFixed(2);
                    
                    // Add or update IVPDCAAS cell
                    let ivpdcaasCell = row.querySelector('td:last-child');
                    if (!ivpdcaasCell || ivpdcaasCell.cellIndex <= ivpdIndex + 1) {
                        ivpdcaasCell = document.createElement('td');
                        row.appendChild(ivpdcaasCell);
                    }
                    ivpdcaasCell.textContent = ivpdcaas;
                    ivpdcaasCell.title = `${assValue} × ${ivpdValue * 100}%`;
                }
            } else {
                console.log(`No AAS value found for sample: ${sampleName} (tried case-insensitive match)`);
            }
        });

        // Add this at the end of the try block, before the success alert
        addDropdownAfterCalculations();

        alert('PDCAAS and IVPDCAAS calculations completed!');

    } catch (error) {
        alert('Error calculating PDCAAS/IVPDCAAS. Please check console for details.');
    }
}


        
        // Then define the button creation function
        function addPDCAASButton() {
            const container = document.querySelector('.button-row');
            if (!container) {
                return;
            }
        
            const pdcaasButton = document.createElement('button');
            pdcaasButton.className = 'amino-btn';
            pdcaasButton.textContent = 'Calculate PDCAAS_IVPDCAAS';
            pdcaasButton.onclick = calculatePDCAASAndIVPDCAAS;
            
            container.appendChild(pdcaasButton);

        }
        
        // Finally, add the event listener for DOM loading
        document.addEventListener('DOMContentLoaded', function() {
            addPDCAASButton();
          });
        </script>
    
    <style>
    .input-section {
        margin-bottom: 20px;
    }
    
    #tableInput {
        width: 100%;
        min-height: 150px;
        margin-bottom: 10px;
        padding: 10px;
    }
    
    .button-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 10px 0;
    }
    
    .process-btn, .calculate-btn, .drop-btn, .amino-btn {
        margin: 0; /* Remove any extra margins */
    padding: 10px; /* Adjust padding */
    height: 100%;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        font-size: 14px;
    }
    
    .process-btn {
        background-color: #4CAF50;
    }
    
    .calculate-btn {
        background-color: #007bff;
    }
    
    .drop-btn {
        background-color: #dc3545;
    }
    
    .amino-btn {
        background-color: #28a745;
    }
    
    .table-container {
        margin-top: 20px;
        overflow-x: auto;
    }
    </style>
</div>

    <div class="status-message"></div>
     

    <script>
        // At the top of your script
let storedAssValues = {};



// To use the values later

        const uploadForm = document.getElementById('uploadForm');
        const fileInput = uploadForm.querySelector('input[type="file"]');
        const selectedFileDiv = document.querySelector('.selected-file');
        const tableContainer = document.getElementById('tableContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingSpinner = document.querySelector('.loading-spinner');
        const statusMessage = document.querySelector('.status-message');

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.background = isError ? '#f44336' : '#4CAF50';
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        fileInput.addEventListener('change', (e) => {
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                selectedFileDiv.textContent = `Selected file: ${fileName}`;
                handleUpload(e.target.files[0]);
            }
        });

        async function handleUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            loadingSpinner.style.display = 'block';
            tableContainer.innerHTML = '';
            downloadBtn.disabled = true;

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.error) {
                    showStatus(data.error, true);
                    return;
                }
                
                displayTables(data.tables);
                showStatus('PDF processed successfully!');
            } catch (error) {
                showStatus('Error processing PDF', true);
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        function setupASSButtonListener(buttonId) {
    document.getElementById(buttonId).addEventListener('click', function() {
        const table = document.querySelector('.multiplication-table');
        
        // Check if AAS column already exists
        if (table.querySelector('th:last-child')?.textContent === 'ASS') {
            return;
        }
        
        // Add header
        const headerRow = table.querySelector('thead tr');
        const newHeader = document.createElement('th');
        newHeader.textContent = 'ASS';
        headerRow.appendChild(newHeader);
        
        // Add minimum values for each row
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td')).slice(1); // Skip first column (Sample)
            const values = cells.map(cell => parseFloat(cell.textContent))
                              .filter(val => !isNaN(val)); // Filter out any NaN values
            
            if (values.length > 0) {
                const minValue = Math.min(...values);
                const newCell = document.createElement('td');
                newCell.textContent = minValue.toFixed(3);
                row.appendChild(newCell);
            } else {
                const newCell = document.createElement('td');
                newCell.textContent = '-';
                row.appendChild(newCell);
            }
        });
    });
}



      
        const modal = document.getElementById('extractModal');
        const closeModal = document.querySelector('.close-modal');
        const extractedDataDiv = document.getElementById('extractedData');
        const loadingOverlay = document.querySelector('.loading-overlay');



        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        async function downloadSelectedTables() {
    const selectedCheckboxes = document.querySelectorAll('.table-checkbox:checked');
    const selectedFiles = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedFiles.length === 0) {
        alert('Please select at least one table to download');
        return;
    }

   
}

function displayTables(tables) {
    tableContainer.innerHTML = '';
    let currentPage = -1;
    
    tables.forEach(table => {
        const pageMatch = table.filename.match(/table_page_(\d+)_idx_/);
        const pageNum = pageMatch ? parseInt(pageMatch[1]) : 0;
        
        const div = document.createElement('div');
        div.className = 'table-item';
        
        if (pageNum !== currentPage) {
            currentPage = pageNum;
            div.innerHTML = `<div class="page-number">Page ${pageNum}</div>`;
        }
        
        div.innerHTML += `
            <img src="/extracted_tables/${table.filename}" 
                 class="table-image" 
                 alt="Table from page ${pageNum}"
                 data-filename="${table.filename}"
                 loading="lazy">
            <div class="table-actions">
                <button class="btn btn-success extract-btn" onclick="extractSingleTable('${table.filename}')">
                    <i class="fas fa-table"></i> Extract Data
                </button>
            </div>
            <div id="result-${table.filename}" class="extraction-result mt-3" style="display: none;">
                <div class="loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Extracting data...</span>
                    </div>
                </div>
                <div class="result-content"></div>
            </div>
        `;
        
        tableContainer.appendChild(div);
    });
}

async function extractSingleTable(filename) {
    const resultContainer = document.getElementById(`result-${filename}`);
    const loadingSpinner = resultContainer.querySelector('.loading-spinner');
    const resultContent = resultContainer.querySelector('.result-content');
    
    try {
        // Show loading state
        resultContainer.style.display = 'block';
        loadingSpinner.style.display = 'block';
        resultContent.innerHTML = '';
        
        const response = await fetch('/extract_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ selected_images: [filename] })
        });

        const data = await response.json();
        
        if (data.success && data.results.length > 0) {
            resultContent.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Extracted Data</h5>
                            <button class="btn btn-sm btn-outline-primary copy-btn" 
                                    onclick="copyToClipboard(this)"
                                    type="button">
                                <i class="fas fa-copy"></i> Copy Data
                            </button>
                        </div>
                        <div class="table-responsive">
                            ${data.results[0].extracted_data}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultContent.innerHTML = `
                <div class="alert alert-danger">
                    Error: ${data.error || 'Failed to extract data'}
                </div>
            `;
        }
    } catch (error) {
        resultContent.innerHTML = `
            <div class="alert alert-danger">
                Error: ${error.message}
            </div>
        `;
    } finally {
        loadingSpinner.style.display = 'none';
    }
}

</script>
<style>

.copy-btn {
    transition: all 0.3s ease;
    margin-bottom: 10px;
}

.copy-btn:active {
    transform: scale(0.95);
}

.copy-btn i {
    margin-right: 5px;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn-success {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
}

.btn-danger {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
}
    .table-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
    }
    
    .extract-btn {
        padding: 5px 10px;
        font-size: 14px;
    }
    
    .extraction-result {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 20px;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    </style>
    <script>



document.querySelectorAll('.image-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateDownloadButton);
});


// Make sure these styles are added to your CSS
const styles = `
    .download-button-container {
        margin-top: 1rem;
        text-align: center;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .btn-secondary:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    .btn-secondary:hover:not(:disabled) {
        background-color: #5a6268;
        border-color: #545b62;
    }

    .mt-3 {
        margin-top: 1rem;
    }
`;


// Add styles to the document
const styleSheet = document.createElement('style');
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

    async function extractTableData(filename) {
    try {
        modal.style.display = 'block';
        loadingOverlay.style.display = 'flex';
        extractedDataDiv.innerHTML = '';

        const response = await fetch('/extract_table_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image_path: filename })
        });

        const data = await response.json();
        
        if (data.success) {
            // Format the JSON data nicely
            extractedDataDiv.innerHTML = `<pre>${JSON.stringify(data.data, null, 2)}</pre>`;
        } else {
            extractedDataDiv.innerHTML = `Error: ${data.error}`;
        }
    } catch (error) {
        extractedDataDiv.innerHTML = 'Error extracting table data';
    } finally {
        loadingOverlay.style.display = 'none';
    }
}



async function copyToClipboard(tableData) {
    try {
        const table = tableData.closest('.card-body').querySelector('table');
        
        if (!table) {
            return;
        }

        // Create text content from table with proper spacing
        let text = '';
        
        // Get headers and data rows
        const rows = table.querySelectorAll('tr');
        rows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll('th, td');
            const rowData = Array.from(cells).map((cell, cellIndex) => {
                // If it's the first cell of the header row, return "Sample" instead of "Sample Name"
                if (rowIndex === 0 && cellIndex === 0) {
                    return "Sample";
                }
                return cell.textContent.trim();
            });
            
            // Join with proper spacing
            text += rowData.join('\t');
            
            // Add newline if not the last row
            if (rowIndex < rows.length - 1) {
                text += '\n';
            }
        });

        // Try modern clipboard API first, fall back to execCommand
        let success = false;
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                success = true;
            } else {
                // Fallback to execCommand
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                success = document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        } catch (e) {
            success = false;
        }

        // Show success/failure message
        const copyBtn = tableData;
        const originalText = copyBtn.innerHTML;
        
        if (success) {
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyBtn.classList.add('btn-success');
            copyBtn.classList.remove('btn-outline-primary');
        } else {
            copyBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
            copyBtn.classList.add('btn-danger');
            copyBtn.classList.remove('btn-outline-primary');
        }
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('btn-success', 'btn-danger');
            copyBtn.classList.add('btn-outline-primary');
        }, 2000);
        
    } catch (err) {
        alert('Failed to copy table data: ' + err.message);
    }
}
    </script>

<style>
    .table td:first-child {
        font-weight: 500;
        background-color: #f8f9fa;
        white-space: nowrap;
    }
    
    .table td {
        font-size: 0.9rem;
    }
    </style>

    <script>
async function processTableData() {
    const tableInput = document.getElementById('tableInput');
    const tableContainer = document.getElementById('tableContainer');
    const errorMessage = document.getElementById('errorMessage');
    
    try {
        // Split input into lines and filter out empty lines
        const inputLines = tableInput.value.trim().split('\n').filter(line => line.trim());
        
        if (inputLines.length < 2) {
            throw new Error('Not enough data rows');
        }

        // Process headers (first line)
        const headers = inputLines[0].split('\t').map(header => header.trim());

        // Process data rows
        const processedData = [];
        for (let i = 1; i < inputLines.length; i++) {
            const line = inputLines[i].trim();
            if (!line) continue;

            const values = line.split('\t').map(value => {
                // Clean the value
                value = value.trim();
                // If value contains parentheses, extract the main number
                if (value.includes('(')) {
                    return value.split('(')[0].trim();
                }
                return value;
            });

            processedData.push({
                sample: values[0],
                values: values.slice(1)
            });
        }

        // Create table HTML
        let tableHTML = '<table id="dataTable" class="table table-bordered table-striped data-table">';
        
        // Add headers
        tableHTML += '<thead><tr>';
        headers.forEach(header => {
            tableHTML += `<th>${header}</th>`;
        });
        tableHTML += '</tr></thead>';
        
        // Add data rows
        tableHTML += '<tbody>';
        processedData.forEach(row => {
            tableHTML += '<tr>';
            tableHTML += `<td>${row.sample}</td>`; // Sample name
            row.values.forEach(value => {
                tableHTML += `<td>${value}</td>`;
            });
            tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
        errorMessage.style.display = 'none';
        
        // Add copy button
       
        
    } catch (error) {
        errorMessage.textContent = 'Error processing table data: ' + error.message;
        errorMessage.style.display = 'block';
        tableContainer.innerHTML = '';
    }
}


function calculateSums() {
    const table = document.getElementById('dataTable');
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.toUpperCase());
    
    // Check if required columns exist (case-insensitive)
    const requiredColumns = ['MET', 'CYS', 'PHE', 'TYR'];
    const missingColumns = requiredColumns.filter(col => !headers.includes(col));
    
    if (missingColumns.length > 0) {
        alert(`Cannot perform calculation. Missing columns: ${missingColumns.join(', ')}`);
        return;
    }
    
    // Check if calculations were already performed (case-insensitive)
    if (headers.includes('MET+CYS') || headers.includes('PHE+TYR')) {
        alert('Calculations have already been performed');
        return;
    }
    
    // Find column indices (case-insensitive)
    const metIndex = headers.findIndex(h => h === 'MET');
    const cysIndex = headers.findIndex(h => h === 'CYS');
    const pheIndex = headers.findIndex(h => h === 'PHE');
    const tyrIndex = headers.findIndex(h => h === 'TYR');
    
    // Calculate sums and store them
    const sums = [];
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        
        // Function to extract numeric value from cell content
        const getValue = (cell) => {
            if (!cell) return 0;
            const content = cell.textContent;
            // Extract the main number (before brackets if present)
            const match = content.match(/^(-?\d+\.?\d*)/);
            return match ? parseFloat(match[0]) : 0;
        };
        
        // Calculate sums
        const metValue = getValue(cells[metIndex]);
        const cysValue = getValue(cells[cysIndex]);
        const metCysSum = (metValue + cysValue).toFixed(3);
        
        const pheValue = getValue(cells[pheIndex]);
        const tyrValue = getValue(cells[tyrIndex]);
        const pheTyrSum = (pheValue + tyrValue).toFixed(3);
        
        sums.push({ metCysSum, pheTyrSum });
    });
    
    // Remove individual columns and add sum columns
    const headerRow = table.querySelector('thead tr');
    const allRows = table.querySelectorAll('tr');
    
    allRows.forEach((row, rowIndex) => {
        const cells = Array.from(row.children);
        
        // For header row
        if (rowIndex === 0) {
            // Remove individual columns (case-insensitive)
            cells.forEach((cell, index) => {
                const cellText = cell.textContent.toUpperCase();
                if (cellText === 'MET' || cellText === 'CYS') {
                    row.removeChild(cell);
                }
                if (cellText === 'PHE' || cellText === 'TYR') {
                    row.removeChild(cell);
                }
            });
            
            // Find position to insert new headers
            const insertPositionMet = Math.min(metIndex, cysIndex);
            const insertPositionPhe = Math.min(pheIndex, tyrIndex);
            
            // Insert new headers
            const metCysHeader = document.createElement('th');
            metCysHeader.textContent = 'MET+CYS';
            metCysHeader.className = 'numeric-column';
            
            const pheTyrHeader = document.createElement('th');
            pheTyrHeader.textContent = 'PHE+TYR';
            pheTyrHeader.className = 'numeric-column';
            
            // Insert at correct positions
            const remainingCells = row.children;
            row.insertBefore(metCysHeader, remainingCells[insertPositionMet]);
            row.insertBefore(pheTyrHeader, remainingCells[insertPositionPhe]);
        } else {
            // For data rows
            cells.forEach((cell, index) => {
                if (index === metIndex || index === cysIndex) {
                    row.removeChild(cell);
                }
                if (index === pheIndex || index === tyrIndex) {
                    row.removeChild(cell);
                }
            });
            
            // Insert sum values
            const sumIndex = rowIndex - 1; // Adjust for header row
            if (sumIndex >= 0 && sumIndex < sums.length) {
                const metCysCell = document.createElement('td');
                metCysCell.textContent = sums[sumIndex].metCysSum;
                metCysCell.className = 'numeric-column';
                
                const pheTyrCell = document.createElement('td');
                pheTyrCell.textContent = sums[sumIndex].pheTyrSum;
                pheTyrCell.className = 'numeric-column';
                
                // Insert at correct positions
                const remainingCells = row.children;
                row.insertBefore(metCysCell, remainingCells[Math.min(metIndex, cysIndex)]);
                row.insertBefore(pheTyrCell, remainingCells[Math.min(pheIndex, tyrIndex)]);
            }
        }
    });
    
    // Disable the calculate button after successful calculation
    const calculateButton = document.querySelector('.calculate-btn');
    if (calculateButton) {
        calculateButton.disabled = true;
        calculateButton.style.backgroundColor = '#cccccc';
        calculateButton.style.cursor = 'not-allowed';
    }
}


function dropPDCAASColumns() {
    const table = document.getElementById('dataTable');
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.toLowerCase());
    
    // Check if the columns exist (case insensitive)
    const columnsToDrop = ['pdcaas', 'in vitro pdcaas'];
    const existingColumns = columnsToDrop.filter(col => 
        headers.some(header => header.toLowerCase() === col)
    );
    
    if (existingColumns.length === 0) {
        alert('No PDCAAS columns found to drop');
        return;
    }
    
    // Get indices of columns to drop
    const dropIndices = headers
        .map((header, index) => columnsToDrop.some(col => header === col) ? index : -1)
        .filter(index => index !== -1);
    
    // Remove columns from all rows
    const allRows = table.querySelectorAll('tr');
    allRows.forEach(row => {
        const cells = Array.from(row.children);
        // Remove cells from right to left to maintain correct indices
        dropIndices.sort((a, b) => b - a).forEach(index => {
            if (cells[index]) {
                row.removeChild(cells[index]);
            }
        });
    });
    
    // Disable the drop button after successful removal
    const dropButton = document.querySelector('.drop-btn');
    if (dropButton) {
        dropButton.disabled = true;
        dropButton.style.backgroundColor = '#cccccc';
        dropButton.style.cursor = 'not-allowed';
    }
}



function calculateAminoAcids() {
    const table = document.getElementById('dataTable');
    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.toUpperCase());
    
    // Define essential amino acids
    const essential_amino_acids = [
        'THR', 'SER', 'GLU', 'PRO', 'GLY', 'ALA',
        'VAL', 'ILE', 'LEU', 'HIS', 'LYS', 'ARG', 'TRP',
        'MET+CYS', 'PHE+TYR'
    ];
    
    // Check if %CP column exists (case-insensitive)
    const cpColumnIndex = headers.findIndex(h => h === '%CP');
    if (cpColumnIndex === -1) {
        alert('Cannot perform calculation. Missing %CP column.');
        return;
    }
    
    // Check if all required amino acid columns exist (case-insensitive)
    const missingColumns = essential_amino_acids.filter(acid => {
        const upperAcid = acid.toUpperCase();
        return !headers.some(header => header === upperAcid) && 
               !(upperAcid === 'MET+CYS' && headers.some(h => h === 'MET+CYS')) &&
               !(upperAcid === 'PHE+TYR' && headers.some(h => h === 'PHE+TYR'));
    });
    
    if (missingColumns.length > 0) {
        alert(`Cannot perform calculation. Missing columns: ${missingColumns.join(', ')}`);
        return;
    }
    
    // Create new table data
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const newTableData = [];
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const sampleName = cells[0].textContent;
        const cpValue = parseFloat(cells[cpColumnIndex].textContent);
        
        const rowData = {
            Sample: sampleName
        };
        
        // Calculate values for each amino acid (case-insensitive)
        essential_amino_acids.forEach(acid => {
            const acidIndex = headers.findIndex(h => h === acid.toUpperCase());
            if (acidIndex !== -1) {
                const acidValue = parseFloat(cells[acidIndex].textContent);
                rowData[acid] = ((acidValue * 1000) / cpValue).toFixed(3);
            }
        });
        
        newTableData.push(rowData);
    });
    
    // Create new table HTML
    let newTableHTML = '<table id="aminoAcidsTable" class="data-table"><thead><tr>';
    newTableHTML += '<th class="text-column">Sample</th>';
    essential_amino_acids.forEach(acid => {
        newTableHTML += `<th class="numeric-column">${acid}</th>`;
    });
    newTableHTML += '</tr></thead><tbody>';
    
    newTableData.forEach(row => {
        newTableHTML += '<tr>';
        newTableHTML += `<td class="text-column">${row.Sample}</td>`;
        essential_amino_acids.forEach(acid => {
            newTableHTML += `<td class="numeric-column">${row[acid] || ''}</td>`;
        });
        newTableHTML += '</tr>';
    });
    
    newTableHTML += '</tbody></table>';
    
    // Create container for new table if it doesn't exist
    let aminoTableContainer = document.getElementById('aminoTableContainer');
    if (!aminoTableContainer) {
        aminoTableContainer = document.createElement('div');
        aminoTableContainer.id = 'aminoTableContainer';
        aminoTableContainer.style.marginTop = '20px';
        table.parentNode.insertBefore(aminoTableContainer, table.nextSibling);
    }
    
    // Add title and new table
    aminoTableContainer.innerHTML = '<h3>Essential Amino Acids Calculation Results</h3>' + newTableHTML;
    
    // Disable the button after calculation
    const aminoButton = document.querySelector('.amino-btn');
    if (aminoButton) {
        aminoButton.disabled = true;
        aminoButton.style.backgroundColor = '#cccccc';
        aminoButton.style.cursor = 'not-allowed';
    }
    // After creating the amino acids table, add the demo button
    
    const buttonContainer = document.createElement('div');
    buttonContainer.innerHTML = `
        <div style="display: flex; gap: 10px; margin-top: 20px; align-items: center;">
            <label>Select Reference Pattern:</label>
            <div class="requirements-selector">
                <label>Protein Quality Report 1991:</label>
                <select id="indianAgeGroupSelect" class="age-group-select">
                    <option value="">Select Age Group</option>
                    <option value="Infant">Infant</option>
                    <option value="PreSchool_Child_2_5_Yrs">PreSchool Child (2-5 Yrs)</option>
                    <option value="School_Child_10_12_Yrs">School Child (10-12 Yrs)</option>
                    <option value="Adult">Adult</option>
                </select>
            </div>
            <div class="requirements-selector">
                <label>Protein Quality Report 2007:</label>
                <select id="whoAgeGroupSelect" class="age-group-select">
                    <option value="">Select Age Group</option>
                    <option value="0.50">0.50 yr</option>
                    <option value="1-2">1-2 yr</option>
                    <option value="3-10">3-10 yr</option>
                    <option value="11-14">11-14 yr</option>
                    <option value="15-18">15-18 yr</option>
                    <option value=">18">>18 yr</option>
                </select>
            </div>
            <div class="requirements-selector">
                <label>Protein Quality Report 2013:</label>
                <select id="faoWhoUnuSelect" class="age-group-select">
                    <option value="">Select Age Group</option>
                    <option value="infant">Infant (0-6 mo)</option>
                    <option value="child">Child (6mo-3 yr)</option>
                    <option value="above3">> 3 yr</option>
                </select>
            </div>
            <button id="multiplyButton" class="multiply-btn" disabled>
                Calculate
            </button>

        </div>
        <div id="requirementsTableContainer"></div>
        <div id="multiplicationResultContainer"></div>
    `;

    // Add the buttons after the amino acids table
    const aminoTable = document.querySelector('#aminoAcidsTable');
    if (aminoTable) {
        aminoTable.parentNode.insertBefore(buttonContainer, aminoTable.nextSibling);
        
        // Initialize after adding to DOM
        initializeRequirementsControls();
    }


    
// Separate function to initialize controls
function initializeRequirementsControls() {
    attachSelectListeners();
    const multiplyButton = document.getElementById('multiplyButton');
    const indianSelect = document.getElementById('indianAgeGroupSelect');
    const whoSelect = document.getElementById('whoAgeGroupSelect');
    const faoWhoUnuSelect = document.getElementById('faoWhoUnuSelect');
    const demoButton = document.getElementById('demoButton');

    // Add 1991 Protein Quality Report requirements data
    const proteinQualityReport1991 = {
        'Infant': {
            'HIS': 26, 'ILE': 46, 'LEU': 93, 'LYS': 66,
            'MET+CYS': 42, 'PHE+TYR': 72, 'THR': 43,
            'TRP': 17, 'VAL': 55
        },
        'PreSchool_Child_2_5_Yrs': {  // Match the value in HTML option
            'HIS': 19, 'ILE': 28, 'LEU': 66, 'LYS': 58,
            'MET+CYS': 25, 'PHE+TYR': 63, 'THR': 34,
            'TRP': 11, 'VAL': 35
        },
        'School_Child_10_12_Yrs': {    // Match the value in HTML option
            'HIS': 19, 'ILE': 28, 'LEU': 44, 'LYS': 44,
            'MET+CYS': 22, 'PHE+TYR': 22, 'THR': 28,
            'TRP': 9, 'VAL': 25
        },
        'Adult': {
            'HIS': 16, 'ILE': 13, 'LEU': 19, 'LYS': 16,
            'MET+CYS': 17, 'PHE+TYR': 19, 'THR': 9,
            'TRP': 5, 'VAL': 13
        }
    };

    // Add FAO/WHO/UNU requirements data
    const faoWhoUnuRequirements = {
        'infant': {
            'HIS': 21, 'ILE': 55, 'LEU': 96, 'LYS': 69,
            'MET+CYS': 33, 'PHE+TYR': 94, 'THR': 44,
            'TRP': 17, 'VAL': 55
        },
        'child': {
            'HIS': 20, 'ILE': 32, 'LEU': 66, 'LYS': 57,
            'MET+CYS': 27, 'PHE+TYR': 52, 'THR': 31,
            'TRP': 8.5, 'VAL': 43
        },
        'above3': {
            'HIS': 16, 'ILE': 30, 'LEU': 61, 'LYS': 48,
            'MET+CYS': 23, 'PHE+TYR': 41, 'THR': 28,
            'TRP': 6.6, 'VAL': 40
        }
    };
    const whoRequirements = {
    '0.50': {
        'HIS': 20, 'ILE': 32, 'LEU': 66, 'LYS': 57,
        'MET+CYS': 27, 'PHE+TYR': 52, 'THR': 31,
        'TRP': 8.5, 'VAL': 43
    },
    '1-2': {
        'HIS': 18, 'ILE': 31, 'LEU': 63, 'LYS': 52,
        'MET+CYS': 25, 'PHE+TYR': 46, 'THR': 27,
        'TRP': 7.4, 'VAL': 42
    },
    '3-10': {
        'HIS': 16, 'ILE': 31, 'LEU': 61, 'LYS': 48,
        'MET+CYS': 23, 'PHE+TYR': 41, 'THR': 25,
        'TRP': 6.6, 'VAL': 40
    },
    '11-14': {
        'HIS': 16, 'ILE': 30, 'LEU': 60, 'LYS': 48,
        'MET+CYS': 23, 'PHE+TYR': 41, 'THR': 25,
        'TRP': 6.5, 'VAL': 40
    },
    '15-18': {
        'HIS': 16, 'ILE': 30, 'LEU': 60, 'LYS': 47,
        'MET+CYS': 23, 'PHE+TYR': 40, 'THR': 24,
        'TRP': 6.3, 'VAL': 40
    },
    '>18': {
        'HIS': 15, 'ILE': 30, 'LEU': 59, 'LYS': 45,
        'MET+CYS': 22, 'PHE+TYR': 38, 'THR': 23,
        'TRP': 6, 'VAL': 39
    }
};


    // Handle Indian requirements dropdown
    indianSelect.addEventListener('change', () => {
        if (indianSelect.value) {
            whoSelect.value = '';
            faoWhoUnuSelect.value = '';
            multiplyButton.disabled = false;
        }
    });

    // Handle WHO requirements dropdown
    whoSelect.addEventListener('change', () => {
        if (whoSelect.value) {
            indianSelect.value = '';
            faoWhoUnuSelect.value = '';
            multiplyButton.disabled = false;
        }
    });

    // Handle FAO/WHO/UNU requirements dropdown
    faoWhoUnuSelect.addEventListener('change', () => {
        if (faoWhoUnuSelect.value) {
            indianSelect.value = '';
            whoSelect.value = '';
            multiplyButton.disabled = false;
        }
    });

    // Handle multiply button click
    multiplyButton.addEventListener('click', () => {
        const selectedIndianAge = indianSelect.value;
        const selectedWHOAge = whoSelect.value;
        const selectedFAOWHOUNUAge = faoWhoUnuSelect.value;
        
        try {
            if (selectedIndianAge) {
                const requirements = proteinQualityReport1991[selectedIndianAge];
                if (!requirements) {
                    throw new Error(`No requirements found for age group: ${selectedIndianAge}`);
                }
                multiplyWithIndianRequirements(selectedIndianAge, requirements);
            } else if (selectedWHOAge) {
                const requirements = whoRequirements[selectedWHOAge];
                if (!requirements) {
                    throw new Error(`No requirements found for WHO age group: ${selectedWHOAge}`);
                }
                multiplyWithWHORequirements(selectedWHOAge, requirements);
            } else if (selectedFAOWHOUNUAge) {
                const requirements = faoWhoUnuRequirements[selectedFAOWHOUNUAge];
                if (!requirements) {
                    throw new Error(`No requirements found for FAO/WHO/UNU age group: ${selectedFAOWHOUNUAge}`);
                }
                multiplyWithFAOWHOUNURequirements(selectedFAOWHOUNUAge, requirements);
            }
        } catch (error) {
            document.getElementById('multiplicationResultContainer').innerHTML = `
                <div class="error-message">
                    Error: ${error.message}
                </div>
            `;
        }
    });
}




function multiplyWithFAOWHOUNURequirements(ageGroup, requirements) {
    // Store the pattern info when calculations are performed
    const aminoTable = document.getElementById('aminoAcidsTable');
    const resultContainer = document.getElementById('multiplicationResultContainer');
    const button = document.getElementById('multiplyButton');
    
    try {
        button.disabled = true;
        button.textContent = 'Calculating';

        let ageGroupLabel = {
            'infant': 'Infant (0-6 mo)',
            'child': 'Child (6mo-3 yr)',
            'above3': '> 3 yr'
        }[ageGroup];

        // Get headers that have requirement values
        const headers = Array.from(aminoTable.querySelectorAll('thead th'));
        const validHeaders = headers.filter((th, index) => {
            if (index === 0) return true; // Always include first column (sample names)
            return requirements.hasOwnProperty(th.textContent);
        });

        // Create result table HTML
        let resultHTML = `
            <h3 style="margin-top: 20px;">Multiplication Results with FAO/WHO/UNU Requirements (${ageGroupLabel})</h3>
            <div class="requirements-info">
                <h4>Applied Requirements:</h4>
                <ul>
                    ${Object.entries(requirements)
                        .map(([acid, value]) => `<li>${acid}: ${value}</li>`)
                        .join('')}
                </ul>
            </div>
            <table class="data-table multiplication-table">
                <thead>
                    <tr>
                        ${validHeaders.map(th => `<th>${th.textContent}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        // Process each row
        const rows = aminoTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            resultHTML += '<tr>';
            const cells = row.querySelectorAll('td');
            
            cells.forEach((cell, index) => {
                const header = headers[index].textContent;
                if (index === 0 || requirements.hasOwnProperty(header)) {
                    if (index === 0) {
                        resultHTML += `<td>${cell.textContent}</td>`;
                    } else {
                        const requirement = requirements[header];
                        if (!isNaN(parseFloat(cell.textContent))) {
                            const value = parseFloat(cell.textContent);
                            const result = (value / requirement).toFixed(3);
                            resultHTML += `
                                <td title="Original: ${value} × Requirement: ${requirement}">
                                    ${result}
                                </td>
                            `;
                        } else {
                            resultHTML += `<td>${cell.textContent}</td>`;
                        }
                    }
                }
            });
            
            resultHTML += '</tr>';
        });

        resultHTML += `
                </tbody>
            </table>
            <button id="addASSBtn" class="btn btn-primary" >Calculate AAS</button>
        `;
        
        // Update the container and re-enable the button
        resultContainer.innerHTML = resultHTML;
        button.disabled = false;
        button.textContent = 'Calculate';

        // Add event listener for the AAS button
        const addASSBtn = document.getElementById('addASSBtn');
        if (addASSBtn) {
            addASSBtn.addEventListener('click', function() {
                const table = resultContainer.querySelector('.multiplication-table');
                
                // Check if AAS column already exists
                if (table.querySelector('th:last-child')?.textContent === 'ASS') {
                    return;
                }
                
                // Add header
                const headerRow = table.querySelector('thead tr');
                const newHeader = document.createElement('th');
                newHeader.textContent = 'ASS';
                headerRow.appendChild(newHeader);
                
                // Add minimum values for each row
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('td')).slice(1);
                    const values = cells.map(cell => parseFloat(cell.textContent))
                                      .filter(val => !isNaN(val));
                    
                    if (values.length > 0) {
                        const minValue = Math.min(...values);
                        const newCell = document.createElement('td');
                        newCell.textContent = minValue.toFixed(3);
                        row.appendChild(newCell);
                    } else {
                        const newCell = document.createElement('td');
                        newCell.textContent = '-';
                        row.appendChild(newCell);
                    }
                });

                // Create and add save button if it doesn't exist
                if (!document.getElementById('saveASSBtn')) {
                    const saveBtn = document.createElement('button');
                    saveBtn.id = 'saveASSBtn';
                    saveBtn.className = 'btn btn-success ms-2';
                    saveBtn.textContent = 'Save AAS Values';
                    addASSBtn.insertAdjacentElement('afterend', saveBtn);

                    // Add click handler for save button
                    saveBtn.onclick = function() {
                        const storedAssValues = {};
                        rows.forEach(row => {
                            const sampleName = row.querySelector('td').textContent;
                            const assValue = row.querySelector('td:last-child').textContent;
                            if (assValue !== '-') {
                                storedAssValues[sampleName] = parseFloat(assValue);
                            }
                        });
                        
                        // Save to localStorage
                        localStorage.setItem('assValues', JSON.stringify(storedAssValues));
                        alert('AAS values saved successfully!');
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'Saved!';
                    };
                }
            });
        } else {
            console.error('AAS button not found after adding to DOM');
        }

    } catch (error) {
        resultContainer.innerHTML = `
            <div class="error-message">
                Error: ${error.message}
            </div>
        `;
        button.disabled = false;
        button.textContent = 'Calculate';
    }
    localStorage.setItem('patternYear', '2013');
    localStorage.setItem('patternAgeGroup', ageGroup);
}



// Add this function to use the stored AAS values
function getStoredAssValues() {
    const savedValues = JSON.parse(localStorage.getItem('assValues') || '{}');
    return savedValues;
}

// Example of how to use the stored values
function useStoredAssValues() {
    const assValues = getStoredAssValues();
    return assValues;
}



function multiplyWithIndianRequirements(ageGroup, requirements) {
    const aminoTable = document.getElementById('aminoAcidsTable');
    const resultContainer = document.getElementById('multiplicationResultContainer');
    const button = document.getElementById('multiplyButton');
    
    try {
        // Validate inputs
        if (!requirements || typeof requirements !== 'object') {
            throw new Error('Invalid requirements data');
        }
        if (!aminoTable) {
            throw new Error('Amino acids table not found');
        }
        button.disabled = true;
        button.textContent = 'Calculating...';

        // Get headers that have requirement values
        const headers = Array.from(aminoTable.querySelectorAll('thead th'));
        const validHeaders = headers.filter((th, index) => {
            if (index === 0) return true; // Always include first column (sample names)
            return requirements.hasOwnProperty(th.textContent);
        });

        // Create result table HTML
        let resultHTML = `
            <h3 style="margin-top: 20px;">Multiplication Results with 1991 Requirements (${ageGroup})</h3>
            <div class="requirements-info">
                <h4>Applied Requirements:</h4>
                <ul>
                    ${Object.entries(requirements)
                        .map(([acid, value]) => `<li>${acid}: ${value}</li>`)
                        .join('')}
                </ul>
            </div>
            <table class="data-table multiplication-table">
                <thead>
                    <tr>
                        ${validHeaders.map(th => `<th>${th.textContent}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        // Process each row
        const rows = aminoTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            resultHTML += '<tr>';
            const cells = row.querySelectorAll('td');
            
            cells.forEach((cell, index) => {
                const header = headers[index].textContent;
                if (index === 0 || requirements.hasOwnProperty(header)) {
                    if (index === 0) {
                        resultHTML += `<td>${cell.textContent}</td>`;
                    } else {
                        const requirement = requirements[header];
                        if (!isNaN(parseFloat(cell.textContent))) {
                            const value = parseFloat(cell.textContent);
                            const result = (value / requirement).toFixed(3);
                            resultHTML += `
                                <td title="Original: ${value} × Requirement: ${requirement}">
                                    ${result}
                                </td>
                            `;
                        } else {
                            resultHTML += `<td>${cell.textContent}</td>`;
                        }
                    }
                }
            });
            
            resultHTML += '</tr>';
        });

        resultHTML += `
                </tbody>
            </table>
            <button id="addASSBtn" class="btn btn-primary ">Calculate AAS </button>
        `;

        resultContainer.innerHTML = resultHTML;

        // Add event listener for the AAS button
        document.getElementById('addASSBtn').addEventListener('click', function() {
            const table = resultContainer.querySelector('.multiplication-table');
            
            // Check if AAS column already exists
            if (table.querySelector('th:last-child')?.textContent === 'ASS') {
                return;
            }
            
            // Add header
            const headerRow = table.querySelector('thead tr');
            const newHeader = document.createElement('th');
            newHeader.textContent = 'ASS';
            headerRow.appendChild(newHeader);
            
            // Add minimum values for each row
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).slice(1);
                const values = cells.map(cell => parseFloat(cell.textContent))
                                  .filter(val => !isNaN(val));
                
                if (values.length > 0) {
                    const minValue = Math.min(...values);
                    const newCell = document.createElement('td');
                    newCell.textContent = minValue.toFixed(3);
                    row.appendChild(newCell);
                } else {
                    const newCell = document.createElement('td');
                    newCell.textContent = '-';
                    row.appendChild(newCell);
                }
            });

            // Add save button functionality
            const saveBtn = document.createElement('button');
            saveBtn.id = 'saveASSBtn';
            saveBtn.className = 'btn btn-success ms-2';
            saveBtn.textContent = 'Save AAS Values';
            document.getElementById('addASSBtn').insertAdjacentElement('afterend', saveBtn);

            saveBtn.addEventListener('click', function() {
                try {
                    const assValues = {};
                    rows.forEach(row => {
                        const sampleName = row.querySelector('td').textContent;
                        const assValue = row.querySelector('td:last-child').textContent;
                        if (assValue !== '-') {
                            assValues[sampleName] = parseFloat(assValue);
                        }
                    });
                    
                    localStorage.setItem('assValues', JSON.stringify(assValues));
                    alert('AAS values saved successfully!');
                    this.disabled = true;
                    this.textContent = 'Saved!';
                } catch (error) {
                    alert('Error saving AAS values. Please try again.');
                }
            });
        });

    } catch (error) {
        resultContainer.innerHTML = `
            <div class="error-message">
                Error: ${error.message}
            </div>
        `;
    } finally {
        button.disabled = false;
        button.textContent = 'Calculate';
    }
    localStorage.setItem('patternYear', '1991');
    localStorage.setItem('patternAgeGroup', ageGroup);
    
}


function addASSColumn() {
                    const table = document.querySelector('.multiplication-table');
                    
                    // Add header
                    const headerRow = table.querySelector('thead tr');
                    const newHeader = document.createElement('th');
                    newHeader.textContent = 'ASS';
                    headerRow.appendChild(newHeader);
                    
                    // Add minimum values for each row
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cells = Array.from(row.querySelectorAll('td')).slice(1); // Skip first column (Sample)
                        const values = cells.map(cell => parseFloat(cell.textContent));
                        const minValue = Math.min(...values);
                        
                        const newCell = document.createElement('td');
                        newCell.textContent = minValue.toFixed(2);
                        row.appendChild(newCell);
                    });
                }

// Add this new function to fetch and display requirements
async function fetchRequirementsTable() {
    const container = document.getElementById('requirementsTableContainer');
    const button = document.getElementById('demoButton');
    
    try {
        // Show loading state
        button.disabled = true;
        button.textContent = 'Loading...';
        
        // Fetch data
        const response = await fetch('/get_amino_requirements');
        if (!response.ok) {
            throw new Error('Failed to fetch requirements data');
        }
        
        const result = await response.json();
        
        // Check if data exists and is an array
        if (!result.data || !Array.isArray(result.data)) {
            throw new Error('Invalid data format received');
        }
        
        // Create table HTML
        let tableHTML = `
            <h3 style="margin-top: 20px;">Amino Acid Requirements</h3>
            <table class="data-table requirements-table">
                <thead>
                    <tr>
                        <th>AminoAcid</th>
                        <th>Infant</th>
                        <th>PreSchool_Child_2_5_Yrs</th>
                        <th>School_Child_10_12_Yrs</th>
                        <th>Adult</th>
                    </tr>
                </thead>
                <tbody>
                    ${result.data.map(row => `
                        <tr>
                            <td>${row.AminoAcid || ''}</td>
                            <td>${row.Infant || ''}</td>
                            <td>${row.PreSchool_Child_2_5_Yrs || ''}</td>
                            <td>${row.School_Child_10_12_Yrs || ''}</td>
                            <td>${row.Adult || ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        // Update container
        container.innerHTML = tableHTML;
        
    } catch (error) {
        container.innerHTML = `
            <div class="error-message">
                Error loading requirements data: ${error.message}
                <br>
                Please check the console for more details.
            </div>
        `;
    } finally {
        // Reset button
        button.disabled = false;
        button.textContent = 'Show Requirements Table';
    }
}
    function multiplyWithSchoolChildValues() {
    // Define the School Child requirements
    const schoolChildValues = {
        'HIS': 19,
        'ILE': 28,
        'LEU': 44,
        'LYS': 44,
        'MET+CYS': 22,
        'PHE+TYR': 22,
        'THR': 28,
        'TRP': 9,
        'VAL': 25
    };

    const aminoTable = document.getElementById('aminoAcidsTable');
    const resultContainer = document.getElementById('multiplicationResultContainer');
    if (!aminoTable) return;

    // Get headers
    const headers = Array.from(aminoTable.querySelectorAll('thead th')).map(th => th.textContent);

    // Create result table HTML
    let resultHTML = `
        <h3 style="margin-top: 20px;">Multiplication Results with School Child Requirements</h3>
        <div class="requirements-info">
            <h4>Applied Requirements (School Child 10-12 Years):</h4>
            <ul>
                ${Object.entries(schoolChildValues)
                    .map(([acid, value]) => `<li>${acid}: ${value}</li>`)
                    .join('')}
            </ul>
        </div>
        <table class="data-table multiplication-table">
            <thead>
                <tr>
                    ${headers.map(header => `<th>${header}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
    `;

    // Process each row
    const rows = aminoTable.querySelectorAll('tbody tr');
    rows.forEach(row => {
        resultHTML += '<tr>';
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            if (index === 0) {
                // Sample name column
                resultHTML += `<td>${cell.textContent}</td>`;
            } else {
                const headerName = headers[index];
                const requirement = schoolChildValues[headerName];
                if (requirement && !isNaN(parseFloat(cell.textContent))) {
                    const originalValue = parseFloat(cell.textContent);
                    const multipliedValue = (originalValue / requirement).toFixed(3);
                    resultHTML += `
                        <td title="Original: ${originalValue} × Requirement: ${requirement}">
                            ${multipliedValue}
                        </td>
                    `;
                } else {
                    resultHTML += `<td>${cell.textContent}</td>`;
                }
            }
        });
        resultHTML += '</tr>';
    });

    resultHTML += `
            </tbody>
        </table>
    `;

    // Display the result tablet
    resultContainer.innerHTML = resultHTML;
}
}


// Add this function at the start of your script
function setupASSButton(tableContainer) {
    // First remove any existing AAS button to avoid duplicates
    const existingButton = tableContainer.querySelector('#addASSBtn');
    if (existingButton) {
        existingButton.remove();
    }

    // Add new button after the table
    const assButton = document.createElement('button');
    assButton.id = 'addASSBtn';
    assButton.className = 'btn btn-primary mt-3';
    assButton.textContent = 'Calculate AAS ';
    
    // Find the table and add the button after it
    const table = tableContainer.querySelector('.data-table');
    table.insertAdjacentElement('afterend', assButton);

    // Add click event listener
    assButton.addEventListener('click', function() {
        // Check if AAS column already exists
        if (table.querySelector('th:last-child')?.textContent === 'ASS') {
            return;
        }
        
        // Add header
        const headerRow = table.querySelector('thead tr');
        const newHeader = document.createElement('th');
        newHeader.textContent = 'ASS';
        headerRow.appendChild(newHeader);
        
        // Add minimum values for each row
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td')).slice(1); // Skip first column (Sample)
            const values = cells.map(cell => parseFloat(cell.textContent))
                              .filter(val => !isNaN(val)); // Filter out any NaN values
            
            if (values.length > 0) {
                const minValue = Math.min(...values);
                const newCell = document.createElement('td');
                newCell.textContent = minValue.toFixed(3);
                row.appendChild(newCell);
            } else {
                const newCell = document.createElement('td');
                newCell.textContent = '-';
                row.appendChild(newCell);
            }
        });
    });
}


function multiplyWithWHORequirements(ageGroup, requirements) {
    const aminoTable = document.getElementById('aminoAcidsTable');
    const resultContainer = document.getElementById('multiplicationResultContainer');
    const button = document.getElementById('multiplyButton');
    
    try {
        button.disabled = true;
        button.textContent = 'Calculating...';

        // Get headers that have requirement values
        const headers = Array.from(aminoTable.querySelectorAll('thead th'));
        const validHeaders = headers.filter((th, index) => {
            if (index === 0) return true; // Always include first column (sample names)
            return requirements.hasOwnProperty(th.textContent);
        });

        // Create result table HTML
        let resultHTML = `
            <h3 style="margin-top: 20px;">Multiplication Results with WHO Requirements (${ageGroup} years)</h3>
            <div class="requirements-info">
                <h4>Applied Requirements:</h4>
                <ul>
                    ${Object.entries(requirements)
                        .map(([acid, value]) => `<li>${acid}: ${value}</li>`)
                        .join('')}
                </ul>
            </div>
            <table class="data-table multiplication-table">
                <thead>
                    <tr>
                        ${validHeaders.map(th => `<th>${th.textContent}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        // Process each row
        const rows = aminoTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            resultHTML += '<tr>';
            const cells = row.querySelectorAll('td');
            
            cells.forEach((cell, index) => {
                const header = headers[index].textContent;
                if (index === 0 || requirements.hasOwnProperty(header)) {
                    if (index === 0) {
                        resultHTML += `<td>${cell.textContent}</td>`;
                    } else {
                        const requirement = requirements[header];
                        if (!isNaN(parseFloat(cell.textContent))) {
                            const value = parseFloat(cell.textContent);
                            const result = (value / requirement).toFixed(3);
                            resultHTML += `
                                <td title="Original: ${value} × Requirement: ${requirement}">
                                    ${result}
                                </td>
                            `;
                        } else {
                            resultHTML += `<td>${cell.textContent}</td>`;
                        }
                    }
                }
            });
            
            resultHTML += '</tr>';
        });

        resultHTML += `
                </tbody>
            </table>
              <button id="addASSBtn" class="btn btn-primary ">Calculate AAS</button>
        `;

        resultContainer.innerHTML = resultHTML;
          // Add event listener for the AAS button
          document.getElementById('addASSBtn').addEventListener('click', function() {
            const table = resultContainer.querySelector('.multiplication-table');
            
            // Check if AAS column already exists
            if (table.querySelector('th:last-child')?.textContent === 'ASS') {
                return;
            }
            
            // Add header
            const headerRow = table.querySelector('thead tr');
            const newHeader = document.createElement('th');
            newHeader.textContent = 'ASS';
            headerRow.appendChild(newHeader);
            
            // Add minimum values for each row
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).slice(1);
                const values = cells.map(cell => parseFloat(cell.textContent))
                                  .filter(val => !isNaN(val));
                
                if (values.length > 0) {
                    const minValue = Math.min(...values);
                    const newCell = document.createElement('td');
                    newCell.textContent = minValue.toFixed(3);
                    row.appendChild(newCell);
                } else {
                    const newCell = document.createElement('td');
                    newCell.textContent = '-';
                    row.appendChild(newCell);
                }
            });

            // Remove existing save button if it exists
            const existingSaveBtn = document.getElementById('saveASSBtn');
            if (existingSaveBtn) {
                existingSaveBtn.remove();
            }

            // Create and add save button
            const saveBtn = document.createElement('button');
            saveBtn.id = 'saveASSBtn';
            saveBtn.className = 'btn btn-success ms-2';
            saveBtn.textContent = 'Save AAS Values';
            
            // Add save button next to AAS button
            const addASSBtn = document.getElementById('addASSBtn');
            addASSBtn.insertAdjacentElement('afterend', saveBtn);

            // Add click handler for save button
            saveBtn.onclick = function() {
                try {
                    const assValues = {};
                    rows.forEach(row => {
                        const sampleName = row.querySelector('td').textContent;
                        const assValue = row.querySelector('td:last-child').textContent;
                        if (assValue !== '-') {
                            assValues[sampleName] = parseFloat(assValue);
                        }
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('assValues', JSON.stringify(assValues));
                    alert('AAS values saved successfully!');
                    this.disabled = true;
                    this.textContent = 'Saved!';
                } catch (error) {
                    alert('Error saving AAS values. Please try again.');
                }
            };

        });
    } catch (error) {
        resultContainer.innerHTML = `
            <div class="error-message">
                Error: ${error.message}
            </div>
        `;
    }
    localStorage.setItem('patternYear', '2007');
    localStorage.setItem('patternAgeGroup', ageGroup);
}



    </script>


<script>
function calculateAndSaveCP() {
    try {
        const table = document.querySelector('#dataTable');
        if (!table) {
            alert('Please process the table data first!');
            return;
        }

        const headers = Array.from(table.querySelectorAll('thead th'));
        // const cpIndex = headers.findIndex(th => th.textContent === '%CP');
        const cpIndex = headers.findIndex(th => th.textContent === '%CP' || th.textContent === 'PRO');

        
        if (cpIndex === -1) {
            throw new Error('Column %CP not found');
        }

        const cpValues = {};
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const sampleName = cells[0].textContent.trim();
            let cpValue = cells[cpIndex].textContent.trim();
            
            // Handle values with parentheses
            if (cpValue.includes('(')) {
                cpValue = cpValue.split('(')[0].trim();
            }
            
            cpValue = parseFloat(cpValue);
            
            if (!isNaN(cpValue)) {
                cpValues[sampleName] = cpValue;
            } else {
                console.warn(`Invalid CP value for sample ${sampleName}: ${cpValue}`);
            }
        });

        // Check if we found any values
        if (Object.keys(cpValues).length === 0) {
            throw new Error('No valid CP values found in the table');
        }

        // Save to localStorage
        localStorage.setItem('cpValues', JSON.stringify(cpValues));
        
        // Create a summary of saved values
        let summaryText = 'Saved CP values:\n';
        Object.entries(cpValues).forEach(([sample, value]) => {
            summaryText += `${sample}: ${value}%\n`;
        });
        
        // Show success message with summary
        alert('CP values saved successfully!\n\n' + summaryText);
        

        // Optional: Highlight the saved values in the table
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const sampleName = cells[0].textContent.trim();
            if (cpValues[sampleName]) {
                cells[cpIndex].style.backgroundColor = '#e8f5e9';
                cells[cpIndex].title = 'Saved CP value: ' + cpValues[sampleName];
            }
        });

    } catch (error) {
        alert('Error calculating CP: ' + error.message);
    }
}

function getSavedCPValues() {
    try {
        const savedValues = localStorage.getItem('cpValues');
        if (!savedValues) {
            return null;
        }
        return JSON.parse(savedValues);
    } catch (error) {
        return null;
    }
}




    // Add this function to create RACC input and CSS calculation
function addRaccInputAndCssColumn() {
    const tableContainer = document.getElementById('tableContainer');
    if (!tableContainer) return;

    // Create RACC input container
    const raccContainer = document.createElement('div');
    raccContainer.className = 'racc-container mt-3 mb-3';
    raccContainer.innerHTML = `
        <div class="input-group" style="max-width: 500px;">
            <span class="input-group-text">RACC Value:</span>
            <input type="number" id="raccValue" class="form-control" placeholder="Enter RACC value">
            <button class="btn btn-primary" onclick="calculateCSS()">Calculate CCS</button>
        </div>
    `;

    // Add RACC input before the dropdown
    const dropdown = tableContainer.querySelector('.dropdown-container');
    if (dropdown) {
        tableContainer.insertBefore(raccContainer, dropdown);
    } else {
        tableContainer.appendChild(raccContainer);
    }
}



</script>

</body>
</html>